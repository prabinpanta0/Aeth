name: Push to AUR

on:
    push:
        branches: ["main"]

jobs:
    push-to-aur:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup SSH agent
              uses: webfactory/ssh-agent@v0.8.1
              with:
                  ssh-private-key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}

            - name: Ensure AUR host key
              run: |
                  mkdir -p ~/.ssh
                  ssh-keyscan -t ed25519 aur.archlinux.org >> ~/.ssh/known_hosts

            - name: Push `main` to AUR `master`
              env:
                  AUR_REPO: aur@aur.archlinux.org:aeth-git.git
              run: |
                  set -euo pipefail
                  git config user.name "GitHub Actions"
                  git config user.email "actions@github.com"
                  git remote add aur "$AUR_REPO" || true
                  # Try a regular push first
                  if git push aur main:master --follow-tags; then
                    echo "Pushed main -> master on AUR"
                    exit 0
                  fi
                  echo "Regular push failed, fetching remote and attempting force-with-lease push"
                  git fetch aur master || true
                  git push aur main:master --force-with-lease
